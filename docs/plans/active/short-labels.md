# Short Label System for Profile Builder

**Status:** Planning  
**Created:** 2026-02-15  
**Motivation:** User feedback — profile builder over-index chart shows truncated long text as headers (e.g. "I am aroused by...") with the same text repeated below in smaller text. Redundant and ugly on mobile.

---

## The Problem

Long survey question column names like *"I am aroused by being dominant in sexual interactions"* get truncated to *"I am aroused by being dominant in..."* and then the same truncated text appears again as a subtitle — redundant and ugly, especially on mobile.

Currently columns have two representations:
- **`name`** (raw): The raw column name, e.g. `"I am aroused by being dominant in sexual interactions" (6w3xquw)`
- **`displayName`** (human-readable): Generated by `buildDisplayName()` in `profile-schema.mjs`, possibly overridden via `human-labels.json`, truncated at 60 chars

The over-index chart then combines `displayName + ": " + valueLabel` and truncates the whole thing at 45 chars via `truncateLabel()`.

## The Solution: Three-Tier Label System

Add a third tier — **`shortLabel`** — a concise, category-style label.

| Tier | Example | Used For |
|------|---------|----------|
| **`name`** (raw) | `"I am aroused by being dominant in sexual interactions" (6w3xquw)` | Internal/technical |
| **`shortLabel`** (NEW) | `"Dominant arousal"` | Primary UI display (chart labels, combobox triggers) |
| **`displayName`** (existing) | `"I am aroused by being dominant in sexual interactions"` | Tooltips, subtitles, detail views |

---

## Implementation Plan

### Phase 1: Type System (no runtime impact)

**`src/lib/schema/types.ts`** — Add `shortLabel` to `ColumnMetadata`:
```typescript
export interface ColumnMetadata {
  name: string;
  displayName?: string;
  shortLabel?: string;  // NEW: Concise UI label
  duckdbType: string;
  logicalType: LogicalType;
  // ... rest unchanged
}
```

**`src/lib/api/contracts.ts`** — Add to Zod schema:
```typescript
export const ColumnMetadataSchema = z.object({
  name: z.string(),
  displayName: z.string().optional(),
  shortLabel: z.string().optional(),  // NEW
  // ... rest unchanged
});
```

### Phase 2: Schema Generation (build-time)

**Create `src/lib/schema/short-labels.json`** — Hand-curated overrides for columns where auto-generation doesn't produce a good result:
```json
{
  "_comment": "Concise short labels for columns with long survey question displayNames",
  "\"I am aroused by being dominant in sexual interactions\" (6w3xquw)": "Dominant arousal",
  "\"I find age-related things (beyond \"normal\" stuff like being attracted to people your own age) to be:\" (92qqx0)": "Age-related interest"
}
```

**`scripts/profile-schema.mjs`** — Add `buildShortLabel()` function:
1. Check `shortLabelsMap[name]` for hand-curated override → return if exists
2. If `displayName` ≤ 30 characters → return `displayName` (already short enough)
3. Apply algorithmic prefix stripping:
   - Strip `"I am aroused by "` → remainder (capitalized)
   - Strip `"I find "` → remainder + " interest"
   - Strip `"To what extent do you agree with this statement: "` → remainder
   - Strip `"I sometimes find "` → remainder
   - Strip quote-wrapped question patterns `"..."` → extract core subject
4. Truncate result to 35 characters max
5. Return generated short label

**Load short-labels.json** at startup (same pattern as human-labels.json loading):
```javascript
let shortLabels = {};
try {
  const shortLabelsPath = resolve(projectRoot, "src", "lib", "schema", "short-labels.json");
  const raw = await readFile(shortLabelsPath, "utf8");
  shortLabels = Object.fromEntries(
    Object.entries(JSON.parse(raw)).filter(([key]) => !key.startsWith("_")),
  );
  console.log(`Loaded ${Object.keys(shortLabels).length} short label overrides`);
} catch {
  console.log("No short-labels.json found, using auto-generated short labels only");
}
```

**Output `shortLabel`** for every column in `columns.generated.json`.

### Phase 3: Runtime Utilities (no UI changes yet)

**`src/lib/format-labels.ts`** — Add `getColumnShortLabel()`:
```typescript
export function getColumnShortLabel(column: ColumnWithDisplayName & { shortLabel?: string }): string {
  if (column.shortLabel?.trim()) {
    return stripHashSuffix(column.shortLabel);
  }
  const display = getColumnDisplayName(column);
  if (display.length <= 30) return display;
  return display.length > 35 ? `${display.slice(0, 32)}...` : display;
}
```

Fallback chain: `shortLabel → displayName (if ≤30 chars) → truncated displayName`

### Phase 4: UI Component Updates (visible UX changes)

**`src/components/charts/over-index-chart.tsx`**:
- Add `shortLabel?: string` and `fullLabel?: string` to `OverIndexChartRow` interface
- Use `shortLabel` as primary display text
- Use `fullLabel` as tooltip text (via `title` attribute)
- Remove the `truncateLabel()` function (no longer needed)

**`src/routes/profile.tsx`** — Update label construction:
- In `runSingleCohort` (~line 479): Build both `shortLabel` and `fullLabel` for over-indexing items
- In comparison mode (~line 555): Same pattern for direct differences
- Pass both labels through to chart components

**`src/components/column-combobox.tsx`** (optional, lower priority):
- Show `shortLabel` in the trigger button display for compact mobile rendering

### Phase 5: Initial Curation (ongoing)

- Create `short-labels.json` with ~20 hand-curated entries for the most problematic columns
- Run `pnpm profile-schema` to regenerate `columns.generated.json`
- Test in profile builder with various cohorts
- Refine algorithmic rules and overrides based on results

---

## Key Design Decisions

| Decision | Choice | Reasoning |
|----------|--------|-----------|
| Storage | Separate `short-labels.json` | Preserves backward compatibility with `human-labels.json` |
| Generation | Auto-generation + hand-curated overrides | Full coverage out of the box, refinable over time |
| Max length | 35 chars for shortLabel | Fits mobile over-index chart width (~220px at 0.87rem serif) |
| Compatibility | Keep existing `label` field, add `shortLabel`/`fullLabel` | Non-breaking change |

---

## Data Flow

```
short-labels.json ─┐
                    ├──→ profile-schema.mjs ──→ columns.generated.json (with shortLabel)
human-labels.json ──┘                              │
                                                   ▼
                                              metadata.ts ──→ /api/schema route
                                                   │
                                                   ▼
                                    format-labels.ts: getColumnShortLabel()
                                                   │
                                                   ▼
                              profile.tsx ──→ over-index-chart.tsx (shortLabel as primary)
```

---

## Testing Checklist

- [ ] Schema generation: `pnpm profile-schema` produces `shortLabel` for all columns
- [ ] API contract: `/api/schema` validates with updated Zod schema
- [ ] Profile builder (single mode): Over-index chart shows concise labels
- [ ] Profile builder (compare mode): Differences section shows short labels
- [ ] Tooltip: Hovering shows full label text
- [ ] Mobile (375px): Labels don't overflow or truncate badly
- [ ] Fallback: Columns without shortLabel gracefully fall back to displayName

---

## Open Questions

1. **Scope**: Should short labels apply just to the over-index charts, or also to data tables, relationship graphs, crosstab axes?
2. **Label style**: Noun phrases ("Dominant arousal") vs action phrases ("Being dominant")? Preserve first-person voice?
3. **Value display**: `"Short label: value"` in chart, or `"Short label"` with value as subtitle?
4. **Priority columns**: Which columns appear most frequently in profile results and should be prioritized for hand-curation?
