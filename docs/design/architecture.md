# Architecture

## Stack
- **Framework**: TanStack Start (React) + Nitro (server runtime)
- **Styling**: Tailwind v4
- **Build**: Vite 7, TypeScript strict mode
- **Data engine (web/API)**: DuckDB CLI (`duckdb -json`) over `data/BKSPublic.parquet`
- **Data engine (metadata generation)**: `@duckdb/node-api` in `scripts/profile-schema.mjs`
- **Data engine (MCP)**: DuckDB Python bindings in `mcp-server/server.py`
- **Deploy**: Railway (web service + optional MCP service)

## Key Technical Decisions

### Nitro plugin required for deployment
TanStack Start needs `nitro` from `nitro/vite` in `vite.config.ts` to produce `.output/` build artifacts. Without it, Vite outputs to `dist/` which does not include the Nitro server runtime.

### `verbatimModuleSyntax` disabled
TanStack docs warn that `verbatimModuleSyntax: true` can leak server bundles into client bundles. `tsconfig.json` sets it to `false`.

### Entry files
`src/router.tsx` exports `getRouter()`. `src/routeTree.gen.ts` is auto-generated by TanStack during `pnpm dev`/`pnpm build`.

### API route model
Server routes under `src/routes/api/*` are thin wrappers that:
1. Validate request boundaries via Zod contracts in `src/lib/api/contracts.ts`.
2. Apply SQL/read-only guardrails in `src/lib/server/sql-guards.ts`.
3. Execute bounded queries via `src/lib/server/db.ts`.
4. Return typed JSON envelopes (`ok`/`error`) via `src/lib/server/api-response.ts`.

### Why DuckDB CLI in the server layer
`@duckdb/node-api` is used for schema profiling scripts but currently avoided in runtime route bundles because Nitro build/bundling with native `.node` bindings is fragile. Runtime API queries execute via the `duckdb` binary and JSON output, with timeout and row-limit controls.

## Data and Metadata Flow
1. Source parquet lives at `data/BKSPublic.parquet`.
2. `pnpm sync-public-data` copies parquet to `public/BKSPublic.parquet`.
3. `pnpm profile-schema` regenerates `src/lib/schema/columns.generated.json`.
4. `/api/schema`, `/api/stats/$column`, `/api/crosstab`, `/api/query` consume that metadata and parquet data.
5. UI pages (`/`, `/explore`, `/profile`, `/sql`) call the API endpoints.

## Current Route Coverage
- `/` dashboard with schema stats, caveats, missingness, and per-column stats
- `/explore` cross-tab explorer with optional demographic filters
- `/profile` cohort builder with percentile summary cards
- `/sql` SQL console with result grid and CSV export
- `/api/health`, `/api/schema`, `/api/query`, `/api/stats/$column`, `/api/crosstab`
