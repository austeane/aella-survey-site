# Architecture

## Stack
- **Framework**: TanStack Start (React) + Nitro (server runtime)
- **Styling**: Tailwind v4
- **Build**: Vite 7, TypeScript strict mode
- **Data engine (web/API)**: DuckDB CLI (`duckdb -json`) over `data/BKSPublic.parquet`
- **Data engine (metadata generation)**: `@duckdb/node-api` in `scripts/profile-schema.mjs`
- **Data engine (MCP)**: DuckDB Python bindings in `mcp-server/server.py`
- **Deploy**: Railway (web service + optional MCP service)

## Key Technical Decisions

### Nitro plugin required for deployment
TanStack Start needs `nitro` from `nitro/vite` in `vite.config.ts` to produce `.output/` build artifacts. Without it, Vite outputs to `dist/` which does not include the Nitro server runtime.

### `verbatimModuleSyntax` disabled
TanStack docs warn that `verbatimModuleSyntax: true` can leak server bundles into client bundles. `tsconfig.json` sets it to `false`.

### Entry files
`src/router.tsx` exports `getRouter()`. `src/routeTree.gen.ts` is auto-generated by TanStack during `pnpm dev`/`pnpm build`.

### API route model
Server routes under `src/routes/api/*` are thin wrappers that:
1. Validate request boundaries via Zod contracts in `src/lib/api/contracts.ts`.
2. Apply SQL/read-only guardrails in `src/lib/server/sql-guards.ts`.
3. Execute bounded queries via `src/lib/server/db.ts`.
4. Return typed JSON envelopes (`ok`/`error`) via `src/lib/server/api-response.ts`.

### Why DuckDB CLI in the server layer
`@duckdb/node-api` is used for schema profiling scripts but currently avoided as the primary runtime engine because Nitro build/bundling with native `.node` bindings is fragile. Runtime API queries execute via the `duckdb` binary and JSON output, with timeout and row-limit controls. A fallback to `@duckdb/node-api` activates automatically when the CLI binary is not available (e.g., on Railway), with bigint normalization for JSON compatibility.

## Data and Metadata Flow
1. Source parquet lives at `data/BKSPublic.parquet`.
2. `pnpm sync-public-data` copies parquet to `public/BKSPublic.parquet`.
3. `pnpm profile-schema` regenerates `src/lib/schema/columns.generated.json`.
4. `/api/schema`, `/api/stats/$column`, `/api/crosstab`, `/api/query` consume that metadata and parquet data.
5. UI pages and AI docs route (`/llms.txt`) call the shared schema metadata layer and API endpoints.

## Current Route Coverage

### UI Pages
- `/about` — intro page: dataset background, methodology caveats, feature guide, credits (links to Aella's blog post)
- `/` — dashboard with schema stats, global caveats, missingness histogram, tag breakdown, column inspector
- `/explore` — Explore hub landing page with navigation cards for Compare Questions, Browse Topics, Build a Profile, What's Connected?, and Data Quality
- `/explore/crosstab` — cross-tab explorer with pivot matrix, Cramer's V, normalization modes, demographic filters, value-label rendering, URL state sync, cell drilldown, notebook save
- `/columns` — Column Atlas with search, tag filters, sort modes, Column Inspector panel, URL state sync
- `/profile` — cohort builder with single/compare modes, percentile cards, over-indexing signals, cohort rarity metric, URL state sync, notebook save
- `/relationships` — Relationship Finder with precomputed Cramer's V and Pearson correlations for 159 columns, URL state sync
- `/sql` — SQL console with templates, click-to-insert quoted identifiers, CSV export, notebook save
- `/notebook` — Research Notebook with localStorage persistence, inline editing, source links, JSON export

### AI Discovery Route
- `/llms.txt` — machine-readable AI integration docs generated from schema metadata (`getSchemaMetadata`, `listColumns`)

### API Endpoints
- `/api/health`, `/api/schema`, `/api/query`, `/api/stats/$column`, `/api/crosstab`

## Shared Components
- `src/components/pivot-matrix.tsx` — pivot table with normalization, marginals, and bucket metadata for drilldown SQL
- `src/components/column-inspector.tsx` — column detail panel with stats queries
- `src/components/column-combobox.tsx` — searchable column picker used across major routes
- `src/components/data-table.tsx` — generic editorial data table
- `src/components/loading-skeleton.tsx` — phase-aware loading skeletons
- `src/components/missingness-badge.tsx` — null meaning badge (GATED, LATE_ADDED, etc.)
- `src/components/sample-size-display.tsx` — N/non-null/used display
- `src/components/section-header.tsx` — numbered section headers
- `src/components/stat-card.tsx` — stat display card

## Ad-Hoc Data Queries (for agents)

The `duckdb` CLI is installed locally and can query the parquet file directly. This is the fastest way to inspect data without starting the dev server.

```bash
# Basic query
duckdb -c "SELECT column_name, count(*) FROM read_parquet('data/BKSPublic.parquet') WHERE column_name IS NOT NULL GROUP BY 1 ORDER BY 2 DESC"

# JSON output (for piping/parsing)
duckdb -json -c "SELECT DISTINCT whowears FROM read_parquet('data/BKSPublic.parquet') WHERE whowears IS NOT NULL"

# Describe all columns
duckdb -c "DESCRIBE SELECT * FROM read_parquet('data/BKSPublic.parquet')"

# Sample rows
duckdb -c "SELECT * FROM read_parquet('data/BKSPublic.parquet') LIMIT 5"
```

Note: `@duckdb/node-api` and Python `duckdb` are also available but require their respective runtimes. The CLI is the simplest option — no imports or environment setup needed.

## Key Libraries
- `src/lib/notebook-store.ts` — localStorage CRUD for notebook entries
- `src/lib/format.ts` — number/percent formatting utilities
- `src/lib/format-labels.ts` — shared value-label and column display-name formatting
- `src/lib/schema/null-meaning.ts` — null meaning inference (NOT_APPLICABLE, GATED, LATE_ADDED, UNKNOWN)
- `src/lib/schema/metadata.ts` — schema metadata access layer
- `src/lib/schema/relationships.generated.json` — precomputed pairwise associations (3,065 entries)
- `src/lib/duckdb/init.ts` — DuckDB initialization with phase callbacks (`idle -> downloading-wasm -> initializing -> loading-parquet -> ready`)
- `src/lib/duckdb/provider.tsx` — React context exposing `db`, `loading`, `error`, and init `phase`
- `src/lib/duckdb/use-query.ts` — React hook for DuckDB-WASM queries
- `src/lib/duckdb/sql-helpers.ts` — SQL quoting and WHERE clause builder
