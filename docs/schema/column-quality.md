# Column Quality Rules

This document defines the column-quality rules used by Atlas and `/api/schema`.

## Hidden Columns

The following columns are hidden from Atlas and `/api/schema` listings:

- `whowears`
- `ascore`
- `normalsex`
- `knowwhatarousesyou`

Rationale:
- `whowears` and `ascore` are opaque composite encodings without documented formulas.
- `normalsex` uses a negated arousal encoding (`-8` means highest arousal) that is easy to misread.
- `knowwhatarousesyou` is an ambiguous numeric companion to a text question and is not user-friendly for browsing.

Implementation:
- Hidden-column configuration lives in `src/lib/schema/column-flags.ts`.
- `listColumns()` and `listColumnsWithCaveats()` filter hidden columns.
- `listAllColumns()` still exposes raw generated metadata for internal use.

## Value Label Scales

## Arousal scale (0..5)

- `0` = Not arousing
- `1` = Slightly arousing
- `2` = Somewhat arousing
- `3` = Moderately arousing
- `4` = Very arousing
- `5` = Extremely arousing

## Negated vanilla arousal scale (0, -1, -2, -3, -5, -8)

- `0` = Not arousing
- `-1` = Slightly arousing
- `-2` = Somewhat arousing
- `-3` = Moderately arousing
- `-5` = Very arousing
- `-8` = Extremely arousing

## Agreement scale (-3..3)

- `3` = Totally agree
- `2` = Agree
- `1` = Somewhat agree
- `0` = Neutral
- `-1` = Somewhat disagree
- `-2` = Disagree
- `-3` = Totally disagree

Implementation:
- Value-label mapping logic lives in `src/lib/schema/value-labels.ts`.
- `src/lib/schema/metadata.ts` attaches `valueLabels` to exposed column metadata.
- `src/components/column-inspector.tsx` renders `value - label` in the Top Values table.

## Caveat Keys

Two additional caveats are used for interpretation safety:

- `opaque_composite`
- `negated_scale`

Implementation:
- Definitions and matching rules are in `src/lib/schema/caveats.ts`.
- API schema enum is defined in `src/lib/api/contracts.ts`.

## Tagging Rules

Tag inference is generated by `scripts/profile-schema.mjs`.

Current quality fixes include:
- Explicit fetish overrides for commonly mis-tagged fetish intensity columns.
- Demographic exclusion for `marriage100blood`, which otherwise false-matches `age` via substring.

After editing inference rules, regenerate metadata:

```bash
pnpm profile-schema
```

## Known Observed Anomalies

These are observed distribution anomalies in the public sample and should be documented rather than silently normalized:

- `highenergy`: sample values currently observed from `-3` to `2` (no `3` observed).
- `allrollidentity`: sample values currently observed as `-1`, `1`, and `2` (no `-2` observed in this sample).

## Maintenance Checklist

When adding or adjusting column-quality rules:

1. Update `src/lib/schema/column-flags.ts`, `src/lib/schema/value-labels.ts`, or `src/lib/schema/caveats.ts`.
2. If tag logic changed, update `scripts/profile-schema.mjs` and run `pnpm profile-schema`.
3. Run validation:
   - `pnpm check-types`
   - `pnpm test --run`
4. Spot-check `/columns` and `/api/schema`.
